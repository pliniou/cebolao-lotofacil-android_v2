### 🧱 **Prompt 1: Update Project-Level `build.gradle.kts` to Use Modern Plugin and Dependency Versions**

**File:** `/build.gradle.kts`
**Goal:** Ensure use of latest stable Gradle, Kotlin, and Android tools (2024 standards)

```kotlin
// File: build.gradle.kts
pluginManagement {
    repositories {
        gradlePluginPortal()
        google()
        mavenCentral()
    }
}

dependencyResolutionManagement {
    repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
    repositories {
        google()
        mavenCentral()
    }
}

rootProject.name = "CebolaoLotofacil"
include(":app")
```

**Explanation:**

* Ensures centralized repository resolution and consistent plugin versions.
* Sets up for stable Android Gradle Plugin (AGP) 8.x.

**Verification:**

* Run `./gradlew build` to validate no sync or plugin errors occur.

---

### ⚙️ **Prompt 2: Update App-Level `build.gradle.kts` for AGP 8+, Kotlin DSL, Compose BOM, and Dependency Cleanup**

**File:** `/app/build.gradle.kts`
**Goal:** Migrate to Compose BOM, latest Kotlin/Compose/Coroutines, and remove unused libs.

```kotlin
// File: app/build.gradle.kts
plugins {
    id("com.android.application")
    kotlin("android")
    kotlin("kapt")
}

android {
    namespace = "br.com.loterias.cebolaolotofacil"
    compileSdk = 34

    defaultConfig {
        applicationId = "br.com.loterias.cebolaolotofacil"
        minSdk = 24
        targetSdk = 34
        versionCode = 3
        versionName = "1.2.0"

        testInstrumentationRunner = "androidx.test.runner.AndroidJUnitRunner"
    }

    buildTypes {
        release {
            isMinifyEnabled = false
            proguardFiles(getDefaultProguardFile("proguard-android-optimize.txt"), "proguard-rules.pro")
        }
    }

    buildFeatures {
        compose = true
    }

    composeOptions {
        kotlinCompilerExtensionVersion = "1.5.5"
    }

    kotlinOptions {
        jvmTarget = "17"
    }

    packaging {
        resources.excludes += "/META-INF/{AL2.0,LGPL2.1}"
    }
}

dependencies {
    // Compose BOM for version alignment
    implementation(platform("androidx.compose:compose-bom:2024.01.00"))

    // Core Android
    implementation("androidx.core:core-ktx:1.12.0")
    implementation("androidx.lifecycle:lifecycle-runtime-ktx:2.6.2")
    implementation("androidx.activity:activity-compose:1.8.2")
    implementation("androidx.navigation:navigation-compose:2.7.7")

    // Compose UI
    implementation("androidx.compose.ui:ui")
    implementation("androidx.compose.ui:ui-tooling-preview")
    implementation("androidx.compose.material3:material3")

    // Dependency Injection
    implementation("io.insert-koin:koin-android:3.5.3")
    implementation("io.insert-koin:koin-androidx-compose:3.5.3")

    // Coroutine support
    implementation("org.jetbrains.kotlinx:kotlinx-coroutines-android:1.7.3")

    // Testing
    testImplementation("junit:junit:4.13.2")
    androidTestImplementation("androidx.test.ext:junit:1.1.5")
    androidTestImplementation("androidx.test.espresso:espresso-core:3.5.1")
    androidTestImplementation(platform("androidx.compose:compose-bom:2024.01.00"))
    androidTestImplementation("androidx.compose.ui:ui-test-junit4")
    debugImplementation("androidx.compose.ui:ui-tooling")
    debugImplementation("androidx.compose.ui:ui-test-manifest")
}
```

**Explanation:**

* Uses Compose BOM for better dependency alignment.
* Updates all core libraries to stable versions from late 2023 / early 2024.
* Removes legacy or unused dependencies (e.g., Retrofit/Room if not yet used).

**Verification:**

* Sync Gradle and verify no warnings or deprecated calls.
* App should still compile and launch unchanged.

---

### 📂 **Prompt 3: Refactor `MainApplication.kt` to Centralize Koin DI and Prevent Memory Leaks**

**File:** `/app/src/main/java/br/com/loterias/cebolaolotofacil/MainApplication.kt`

```kotlin
// File: MainApplication.kt
package br.com.loterias.cebolaolotofacil

import android.app.Application
import br.com.loterias.cebolaolotofacil.di.appModule
import org.koin.android.ext.koin.androidContext
import org.koin.core.context.startKoin

class MainApplication : Application() {
    override fun onCreate() {
        super.onCreate()
        startKoin {
            androidContext(this@MainApplication)
            modules(appModule)
        }
    }
}
```

**Explanation:**

* Ensures Koin starts once with the correct context.
* Avoids memory leaks by preventing context misuse.

**Verification:**

* Place a log/Toast inside one ViewModel or UseCase to validate DI wiring.

---

### 🧩 **Prompt 4: Define `appModule.kt` for Dependency Injection Across Layers**

**File:** `/app/src/main/java/br/com/loterias/cebolaolotofacil/di/appModule.kt`

```kotlin
// File: di/appModule.kt
package br.com.loterias.cebolaolotofacil.di

import br.com.loterias.cebolaolotofacil.presentation.viewmodel.HomeViewModel
import org.koin.androidx.viewmodel.dsl.viewModel
import org.koin.dsl.module

val appModule = module {
    // ViewModels
    viewModel { HomeViewModel(get()) }

    // UseCases and Repositories will be added after refactoring them
}
```

**Explanation:**

* Starts with ViewModel registration.
* Designed to evolve as UseCases, Repos are refactored.

**Verification:**

* Launch screen using `HomeViewModel` to confirm DI.

---

### 🧼 **Prompt 5: Clean Up `AndroidManifest.xml` (Remove Obsolete Permissions)**

**File:** `/app/src/main/AndroidManifest.xml`

```xml
<!-- File: AndroidManifest.xml -->
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="br.com.loterias.cebolaolotofacil">

    <application
        android:name=".MainApplication"
        android:label="Cebolão Lotofácil"
        android:icon="@mipmap/ic_launcher"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:theme="@style/Theme.CebolaoLotofacil">
        <activity android:name=".presentation.ui.MainActivity"
            android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.MAIN"/>
                <category android:name="android.intent.category.LAUNCHER"/>
            </intent-filter>
        </activity>
    </application>
</manifest>
```

**Explanation:**

* Removes unnecessary permissions (none were used).
* Registers `MainApplication` for Koin startup.

**Verification:**

* App should start and show home screen without crashes.
* Confirm no manifest warnings in lint.

---

Perfeito! Seguindo com a próxima etapa: **Data Layer Refactoring** (sem separação em módulos). Essa fase envolve:

* Reestruturação de repositórios
* Correção de mapeamentos DTO ↔ domínio
* Atualização do uso de `Flow`, `suspend`, e tratamento de erro
* Eliminação de duplicações ou abstrações desnecessárias
* Adoção de boas práticas de composição e testabilidade

---

### 🗃 **Prompt 6: Refatorar `Repository` para Interface Clara com `Flow`, Tratamento de Erros, e Kotlin Idiomático**

**File:** `/app/src/main/java/br/com/loterias/cebolaolotofacil/data/LotofacilRepositoryImpl.kt`

```kotlin
// File: data/LotofacilRepositoryImpl.kt
package br.com.loterias.cebolaolotofacil.data

import br.com.loterias.cebolaolotofacil.domain.model.LotofacilResult
import br.com.loterias.cebolaolotofacil.domain.repository.LotofacilRepository
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.flow
import kotlinx.coroutines.delay

class LotofacilRepositoryImpl : LotofacilRepository {
    override fun getRecentResults(): Flow<List<LotofacilResult>> = flow {
        delay(500) // Simulate fetch
        emit(
            listOf(
                LotofacilResult(
                    concurso = 3041,
                    dezenas = listOf("01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12", "13", "14", "15"),
                    data = "2024-01-15"
                )
            )
        )
    }
}
```

**Explanation:**

* Substitui lógica fixa por `Flow`, facilitando expansão futura com cache ou rede.
* Adota `suspend` idiomático e segura extensão com room/api no futuro.
* Deixa lógica de erro preparada para try/catch.

**Verification:**

* Confirmar recebimento de lista populada na tela inicial.
* Sem crashes ou `MissingBackpressureException`.

---

### 📄 **Prompt 7: Criar Interface de Repositório no Domínio para Separação de Camadas**

**File:** `/app/src/main/java/br/com/loterias/cebolaolotofacil/domain/repository/LotofacilRepository.kt`

```kotlin
// File: domain/repository/LotofacilRepository.kt
package br.com.loterias.cebolaolotofacil.domain.repository

import br.com.loterias.cebolaolotofacil.domain.model.LotofacilResult
import kotlinx.coroutines.flow.Flow

interface LotofacilRepository {
    fun getRecentResults(): Flow<List<LotofacilResult>>
}
```

**Explanation:**

* Interface no domínio evita dependência de implementação concreta.
* Permite substituição por mocks em testes ou por outra fonte (API/Room).

**Verification:**

* Substituir uso direto de `Impl` por injeção da interface no ViewModel.

---

### 🔌 **Prompt 8: Adicionar `LotofacilRepositoryImpl` ao DI Container**

**File:** `/app/src/main/java/br/com/loterias/cebolaolotofacil/di/appModule.kt`
(Modificação incremental do prompt 4)

```kotlin
// In appModule.kt
single<LotofacilRepository> { LotofacilRepositoryImpl() }
```

**Explanation:**

* Registro singleton do repositório para garantir escopo da aplicação.
* Usa binding por interface (`LotofacilRepository`) para desacoplamento.

**Verification:**

* Validar que `HomeViewModel` ou outro consumidor recebe a instância correta via `get()`.

---

### 📦 **Prompt 9: Criar `LotofacilResult` como Modelo de Domínio Imutável e Simples**

**File:** `/app/src/main/java/br/com/loterias/cebolaolotofacil/domain/model/LotofacilResult.kt`

```kotlin
// File: domain/model/LotofacilResult.kt
package br.com.loterias.cebolaolotofacil.domain.model

data class LotofacilResult(
    val concurso: Int,
    val dezenas: List<String>,
    val data: String
)
```

**Explanation:**

* Modelo limpo, focado apenas na lógica da aplicação.
* Facilita mapeamento futuro de DTO/Entity para domínio.

**Verification:**

* Validar serialização correta e que o modelo aparece na UI conforme esperado.

---

### 🧪 **Prompt 10: Criar Teste Unitário Simples para `LotofacilRepositoryImpl`**

**File:** `/app/src/test/java/br/com/loterias/cebolaolotofacil/data/LotofacilRepositoryImplTest.kt`

```kotlin
// File: test/data/LotofacilRepositoryImplTest.kt
package br.com.loterias.cebolaolotofacil.data

import kotlinx.coroutines.test.runTest
import org.junit.Test
import kotlin.test.assertEquals

class LotofacilRepositoryImplTest {
    @Test
    fun `should emit mock result`() = runTest {
        val repository = LotofacilRepositoryImpl()
        val results = repository.getRecentResults().first()
        assertEquals(3041, results.first().concurso)
    }
}
```

**Explanation:**

* Usa `runTest` para corrotina isolada e determinística.
* Valida conteúdo da emissão simulada no `Flow`.

**Verification:**

* Rodar `./gradlew test` e validar sucesso.
* Cobertura mínima de execução do `Flow`.

---

## ✅ **11. Camada de Domínio – UseCases**

---

### 📌 **Prompt 11: Criar UseCase `GetRecentLotofacilResultsUseCase` com Responsabilidade Única**

**File:** `/app/src/main/java/br/com/loterias/cebolaolotofacil/domain/usecase/GetRecentLotofacilResultsUseCase.kt`

```kotlin
// File: domain/usecase/GetRecentLotofacilResultsUseCase.kt
package br.com.loterias.cebolaolotofacil.domain.usecase

import br.com.loterias.cebolaolotofacil.domain.model.LotofacilResult
import br.com.loterias.cebolaolotofacil.domain.repository.LotofacilRepository
import kotlinx.coroutines.flow.Flow

class GetRecentLotofacilResultsUseCase(
    private val repository: LotofacilRepository
) {
    operator fun invoke(): Flow<List<LotofacilResult>> = repository.getRecentResults()
}
```

**Explanation:**

* UseCase isolado com propósito único.
* Operador `invoke()` facilita uso no ViewModel.
* Permite testes unitários diretos.

**Verification:**

* Confirmar chamada via ViewModel.
* Teste pode ser criado com repositório fake.

---

### 🧩 **Prompt 12: Registrar UseCase no DI**

**File:** `/app/src/main/java/br/com/loterias/cebolaolotofacil/di/appModule.kt`
(modificar existente)

```kotlin
// In appModule.kt
single { GetRecentLotofacilResultsUseCase(get()) }
```

**Explanation:**

* Injeta repositório automaticamente.
* Garante reuso do mesmo UseCase entre ViewModels.

---

## 🎯 **13. Camada de Apresentação – ViewModel**

---

### 🧠 **Prompt 13: Refatorar `HomeViewModel` com StateFlow e Manipulação de Estado Idiomática**

**File:** `/app/src/main/java/br/com/loterias/cebolaolotofacil/presentation/viewmodel/HomeViewModel.kt`

```kotlin
// File: presentation/viewmodel/HomeViewModel.kt
package br.com.loterias.cebolaolotofacil.presentation.viewmodel

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import br.com.loterias.cebolaolotofacil.domain.model.LotofacilResult
import br.com.loterias.cebolaolotofacil.domain.usecase.GetRecentLotofacilResultsUseCase
import kotlinx.coroutines.flow.*
import kotlinx.coroutines.launch

data class HomeUiState(
    val isLoading: Boolean = false,
    val results: List<LotofacilResult> = emptyList(),
    val error: String? = null
)

class HomeViewModel(
    private val getRecentResults: GetRecentLotofacilResultsUseCase
) : ViewModel() {

    private val _uiState = MutableStateFlow(HomeUiState())
    val uiState: StateFlow<HomeUiState> = _uiState.asStateFlow()

    init {
        fetchResults()
    }

    private fun fetchResults() {
        viewModelScope.launch {
            _uiState.update { it.copy(isLoading = true) }
            getRecentResults()
                .catch { e -> _uiState.update { it.copy(error = e.message ?: "Unknown error", isLoading = false) } }
                .collect { data -> _uiState.update { it.copy(results = data, isLoading = false) } }
        }
    }
}
```

**Explanation:**

* Usa `StateFlow` para reatividade limpa.
* Manipula loading, data e erro de forma clara.
* Responsabilidade única, pronta para teste.

**Verification:**

* Confirmar recomposição correta no Compose.
* Validar estados via `collectAsState()`.

---

## 🖼 **14. UI – Jetpack Compose**

---

### 🧱 **Prompt 14: Criar `HomeScreen` com State Hoisting, Material 3 e Reusabilidade**

**File:** `/app/src/main/java/br/com/loterias/cebolaolotofacil/presentation/ui/HomeScreen.kt`

```kotlin
// File: presentation/ui/HomeScreen.kt
package br.com.loterias.cebolaolotofacil.presentation.ui

import androidx.compose.foundation.layout.*
import androidx.compose.material3.*
import androidx.compose.runtime.Composable
import androidx.compose.runtime.collectAsState
import androidx.compose.ui.Modifier
import androidx.compose.ui.unit.dp
import androidx.lifecycle.viewmodel.compose.viewModel
import br.com.loterias.cebolaolotofacil.presentation.viewmodel.HomeViewModel
import org.koin.androidx.compose.koinViewModel

@Composable
fun HomeScreen(viewModel: HomeViewModel = koinViewModel()) {
    val state = viewModel.uiState.collectAsState().value

    Scaffold(
        topBar = {
            TopAppBar(title = { Text("Cebolão Lotofácil") })
        }
    ) { padding ->
        when {
            state.isLoading -> LoadingIndicator()
            state.error != null -> ErrorScreen(message = state.error)
            else -> ResultList(results = state.results, modifier = Modifier.padding(padding))
        }
    }
}

@Composable
fun LoadingIndicator() {
    Box(modifier = Modifier.fillMaxSize(), contentAlignment = Alignment.Center) {
        CircularProgressIndicator()
    }
}

@Composable
fun ErrorScreen(message: String) {
    Box(modifier = Modifier.fillMaxSize(), contentAlignment = Alignment.Center) {
        Text(text = message, color = MaterialTheme.colorScheme.error)
    }
}

@Composable
fun ResultList(results: List<br.com.loterias.cebolaolotofacil.domain.model.LotofacilResult>, modifier: Modifier = Modifier) {
    Column(modifier = modifier.padding(16.dp)) {
        results.forEach { result ->
            Text("Concurso ${result.concurso} - ${result.data}")
            Text(result.dezenas.joinToString(" - "), style = MaterialTheme.typography.bodyMedium)
            Spacer(Modifier.height(16.dp))
        }
    }
}
```

**Explanation:**

* Usa Material 3 + Scaffold.
* `Composable`s separados por função: loading, erro, lista.
* Acessibilidade e reusabilidade incluídas.

---

## 🧭 **15. Navegação**

---

### 🧭 **Prompt 15: Refatorar `MainActivity` com `NavHost` Simples e Future-proof**

**File:** `/app/src/main/java/br/com/loterias/cebolaolotofacil/presentation/ui/MainActivity.kt`

```kotlin
// File: presentation/ui/MainActivity.kt
package br.com.loterias.cebolaolotofacil.presentation.ui

import android.os.Bundle
import androidx.activity.ComponentActivity
import androidx.activity.compose.setContent
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Surface
import androidx.compose.runtime.Composable
import androidx.compose.ui.Modifier
import androidx.navigation.compose.NavHost
import androidx.navigation.compose.composable
import androidx.navigation.compose.rememberNavController
import br.com.loterias.cebolaolotofacil.presentation.theme.CebolaoTheme

class MainActivity : ComponentActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContent {
            CebolaoTheme {
                Surface(modifier = Modifier) {
                    AppNavigation()
                }
            }
        }
    }
}

@Composable
fun AppNavigation() {
    val navController = rememberNavController()
    NavHost(navController = navController, startDestination = "home") {
        composable("home") { HomeScreen() }
    }
}
```

---

## 🎨 **16. Theming e Recursos**

---

### 🎨 **Prompt 16: Migrar para `Material3` com Tema Composable**

**File:** `/app/src/main/java/br/com/loterias/cebolaolotofacil/presentation/theme/Theme.kt`

```kotlin
// File: presentation/theme/Theme.kt
package br.com.loterias.cebolaolotofacil.presentation.theme

import androidx.compose.material3.*
import androidx.compose.runtime.Composable

@Composable
fun CebolaoTheme(content: @Composable () -> Unit) {
    MaterialTheme(
        colorScheme = lightColorScheme(),
        typography = Typography(),
        content = content
    )
}
```

---

## 🧹 **17. Limpeza e Finalização**

---

### 🧼 **Prompt 17: Remover Classes Vazias, Duplicadas ou Obsoletas**

* Remova quaisquer arquivos com:

  * `class XYZ {}` (vazio)
  * `// TODO` sem código útil
  * `*Old.kt`, `*Copy.kt`
* Exemplo: `OldMainActivity.kt`, `OldHomeScreen.kt`

---

## 🧪 **18. Verificação Final**

---

### ✅ **Prompt 18: Verificar que Projeto Compila e Passa Lint**

**Steps:**

1. Rodar:

   ```bash
   ./gradlew clean build lint test
   ```
2. Verificar:

   * Sem erros de compilação
   * Sem `@SuppressLint` desnecessários
   * Sem `UnusedImports`
   * Sem classes não utilizadas

---